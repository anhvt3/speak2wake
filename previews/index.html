<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <title>Speak2Wake — Interactive Demo</title>
  <link href="https://fonts.googleapis.com/css2?family=Jost:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    body {
      font-family: 'Jost', sans-serif;
      overflow: hidden;
      height: 100vh;
      background: #060608;
      display: flex;
      justify-content: center;
      align-items: center
    }

    .phone {
      width: 100vw;
      height: 100vh;
      position: relative;
      overflow-y: auto;
      overflow-x: hidden;
      background: #0D0D0F
    }

    @media(min-width:500px) {
      .phone {
        width: 390px;
        height: 844px;
        border-radius: 40px;
        border: 2px solid rgba(255, 107, 0, .15);
        overflow: hidden;
        box-shadow: 0 0 60px rgba(255, 107, 0, .08)
      }
    }

    .screen {
      display: none;
      min-height: 100%;
      padding: 24px;
      padding-top: 50px;
      flex-direction: column
    }

    .screen.active {
      display: flex
    }

    .glass {
      background: rgba(255, 255, 255, .05);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, .08);
      border-radius: 24px
    }

    .glass-dark {
      background: rgba(255, 255, 255, .03);
      border: 1px solid rgba(255, 255, 255, .06);
      border-radius: 16px
    }

    .btn {
      border: none;
      cursor: pointer;
      font-family: inherit;
      font-weight: 600;
      border-radius: 38px;
      transition: all .2s
    }

    .btn:hover {
      filter: brightness(1.1);
      transform: translateY(-1px)
    }

    .btn:active {
      transform: scale(.97)
    }

    .btn-primary {
      background: linear-gradient(135deg, #FF6B00, #FF9F40);
      color: #0D0D0F;
      font-size: 16px
    }

    .btn-secondary {
      background: rgba(255, 107, 0, .12);
      color: #FF9F40;
      border: 1px solid rgba(255, 107, 0, .2);
      font-size: 14px
    }

    .btn-secondary:hover {
      background: rgba(255, 107, 0, .2)
    }

    input,
    select {
      font-family: inherit;
      font-size: 16px
    }

    .toggle {
      width: 48px;
      height: 26px;
      border-radius: 13px;
      position: relative;
      cursor: pointer;
      transition: all .25s
    }

    .toggle.on {
      background: #FF6B00
    }

    .toggle.off {
      background: rgba(255, 255, 255, .12)
    }

    .toggle::after {
      content: '';
      width: 22px;
      height: 22px;
      border-radius: 50%;
      position: absolute;
      top: 2px;
      transition: all .25s
    }

    .toggle.on::after {
      left: 24px;
      background: #FFD700
    }

    .toggle.off::after {
      left: 2px;
      background: rgba(255, 255, 255, .4)
    }

    @keyframes pulse-ring {
      0% {
        transform: scale(.8);
        opacity: .6
      }

      100% {
        transform: scale(1.5);
        opacity: 0
      }
    }

    @keyframes gentle-pulse {

      0%,
      100% {
        transform: scale(1)
      }

      50% {
        transform: scale(1.06)
      }
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0)
      }

      25% {
        transform: translateX(-8px)
      }

      75% {
        transform: translateX(8px)
      }
    }

    @keyframes bell-ring {

      0%,
      100% {
        transform: rotate(0)
      }

      15% {
        transform: rotate(14deg)
      }

      30% {
        transform: rotate(-14deg)
      }

      45% {
        transform: rotate(10deg)
      }

      60% {
        transform: rotate(-10deg)
      }

      75% {
        transform: rotate(4deg)
      }
    }

    @keyframes glow {

      0%,
      100% {
        box-shadow: 0 0 20px rgba(255, 107, 0, .2)
      }

      50% {
        box-shadow: 0 0 40px rgba(255, 107, 0, .4)
      }
    }

    .anim-pulse-ring {
      animation: pulse-ring 1.5s ease-out infinite
    }

    .anim-pulse-ring-d {
      animation: pulse-ring 1.5s ease-out .5s infinite
    }

    .anim-gentle {
      animation: gentle-pulse 2s ease-in-out infinite
    }

    .anim-shake {
      animation: shake .3s ease-in-out
    }

    .anim-bell {
      animation: bell-ring 1s ease-in-out infinite
    }

    .anim-glow {
      animation: glow 2s ease-in-out infinite
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .8);
      backdrop-filter: blur(6px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 20px
    }

    .modal-content {
      background: linear-gradient(160deg, #1A1A1F, #252530);
      border-radius: 24px;
      padding: 24px;
      max-width: 340px;
      width: 100%;
      border: 1px solid rgba(255, 107, 0, .15)
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: rgba(255, 255, 255, .35);
      padding: 10px 16px;
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(13, 13, 15, .9);
      backdrop-filter: blur(8px)
    }

    .day-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      cursor: pointer;
      border: none;
      font-family: inherit;
      transition: all .2s
    }

    .day-btn.active {
      background: #FF6B00;
      color: #0D0D0F;
      font-weight: 600
    }

    .day-btn.inactive {
      background: rgba(255, 255, 255, .08);
      color: rgba(255, 255, 255, .4)
    }

    .cat-pill {
      padding: 5px 14px;
      border-radius: 20px;
      font-size: 13px;
      cursor: pointer;
      border: none;
      font-family: inherit;
      transition: all .2s
    }

    .cat-pill.active {
      background: #FF6B00;
      color: #0D0D0F;
      font-weight: 500
    }

    .cat-pill.inactive {
      background: rgba(255, 255, 255, .06);
      color: rgba(255, 255, 255, .45)
    }

    .cat-pill:hover {
      background: rgba(255, 107, 0, .2);
      color: #FF9F40
    }

    .waveform-bar {
      width: 3px;
      border-radius: 2px;
      background: rgba(255, 107, 0, .5);
      transition: height .08s
    }

    .alarm-card {
      cursor: pointer;
      transition: all .15s;
      border-radius: 24px
    }

    .alarm-card:hover {
      background: rgba(255, 255, 255, .04)
    }

    .alarm-card:active {
      transform: scale(.98)
    }

    .icon-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: none;
      background: rgba(255, 255, 255, .06);
      transition: all .2s
    }

    .icon-btn:hover {
      background: rgba(255, 107, 0, .15)
    }

    .icon-btn svg {
      width: 20px;
      height: 20px;
      fill: none;
      stroke: rgba(255, 255, 255, .7);
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round
    }

    .text-accent {
      color: #FF9F40
    }

    .text-muted {
      color: #9CA3AF
    }

    .text-dim {
      color: rgba(255, 255, 255, .35)
    }

    .flex-center {
      display: flex;
      align-items: center;
      justify-content: center
    }

    .flex-between {
      display: flex;
      align-items: center;
      justify-content: space-between
    }

    .gap-2 {
      gap: 8px
    }

    .gap-3 {
      gap: 12px
    }

    .gap-4 {
      gap: 16px
    }

    .mb-3 {
      margin-bottom: 12px
    }

    .mb-4 {
      margin-bottom: 16px
    }

    .mb-5 {
      margin-bottom: 20px
    }

    .mb-6 {
      margin-bottom: 24px
    }

    .mt-1 {
      margin-top: 4px
    }

    .mt-2 {
      margin-top: 8px
    }

    .mt-3 {
      margin-top: 12px
    }

    .mt-4 {
      margin-top: 16px
    }

    .mt-5 {
      margin-top: 20px
    }

    .p-3 {
      padding: 12px
    }

    .p-4 {
      padding: 16px
    }

    .p-5 {
      padding: 20px
    }

    .p-6 {
      padding: 24px
    }

    .py-3 {
      padding-top: 12px;
      padding-bottom: 12px
    }

    .py-4 {
      padding-top: 16px;
      padding-bottom: 16px
    }

    .w-full {
      width: 100%
    }

    .text-center {
      text-align: center
    }

    .text-xs {
      font-size: 12px
    }

    .text-sm {
      font-size: 14px
    }

    .text-base {
      font-size: 16px
    }

    .text-lg {
      font-size: 18px
    }

    .text-xl {
      font-size: 20px
    }

    .text-2xl {
      font-size: 24px
    }

    .text-3xl {
      font-size: 30px
    }

    .text-4xl {
      font-size: 36px
    }

    .text-5xl {
      font-size: 48px
    }

    .text-7xl {
      font-size: 72px
    }

    .font-medium {
      font-weight: 500
    }

    .font-semibold {
      font-weight: 600
    }

    .font-bold {
      font-weight: 700
    }

    .space-y-3>*+* {
      margin-top: 12px
    }

    .space-y-2>*+* {
      margin-top: 8px
    }
  </style>
</head>

<body>
  <div class="phone" id="phone">
    <div class="status-bar"><span id="clock">9:41</span><span>⚡ 87%</span></div>

    <!-- HOME -->
    <div class="screen active" id="s-home">
      <div class="flex-between mb-5">
        <button class="icon-btn" onclick="showScreen('settings')"><svg viewBox="0 0 24 24">
            <path d="M12 15a3 3 0 100-6 3 3 0 000 6z" />
            <path
              d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9c.26.604.852.997 1.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z" />
          </svg></button>
        <h2 class="text-xl font-semibold" style="color:#F5F5F5">Speak2Wake</h2>
        <button class="icon-btn" onclick="editingId=null;selectedDays=[1,2,3,4,5];showScreen('add')"><svg
            viewBox="0 0 24 24">
            <line x1="12" y1="5" x2="12" y2="19" />
            <line x1="5" y1="12" x2="19" y2="12" />
          </svg></button>
      </div>
      <div id="next-alarm-banner" class="glass p-5 mb-5"></div>
      <div id="alarm-list" class="space-y-3" style="flex:1"></div>
      <button onclick="simulateAlarm()" class="btn btn-primary py-4 w-full mt-5"
        style="font-size:18px;display:flex;align-items:center;justify-content:center;gap:10px">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#0D0D0F" stroke-width="2.5"
          stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9" />
          <path d="M13.73 21a2 2 0 01-3.46 0" />
        </svg>
        Simulate Alarm</button>
      <p class="text-center text-dim text-xs mt-3">500 German words • Phase 1 MVP Demo</p>
    </div>

    <!-- ADD/EDIT ALARM -->
    <div class="screen" id="s-add">
      <div class="flex-between mb-5">
        <button class="icon-btn" onclick="showScreen('home')"><svg viewBox="0 0 24 24">
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg></button>
        <h2 class="text-xl font-semibold" style="color:#F5F5F5" id="add-title">New Alarm</h2>
        <div style="width:40px"></div>
      </div>
      <div class="glass p-6 mb-4 flex-center gap-4">
        <div class="text-center">
          <p class="text-muted text-xl" style="cursor:pointer" onclick="adjTime('h',1)">▲</p><input id="inp-h"
            type="text" value="07"
            style="font-size:56px;font-weight:600;color:#F5F5F5;background:transparent;text-align:center;width:80px;border:none;outline:none;font-family:inherit"
            maxlength="2">
          <p class="text-muted text-xl" style="cursor:pointer" onclick="adjTime('h',-1)">▼</p>
        </div>
        <p style="font-size:48px;font-weight:600;color:rgba(255,255,255,.3)">:</p>
        <div class="text-center">
          <p class="text-muted text-xl" style="cursor:pointer" onclick="adjTime('m',1)">▲</p><input id="inp-m"
            type="text" value="30"
            style="font-size:56px;font-weight:600;color:#F5F5F5;background:transparent;text-align:center;width:80px;border:none;outline:none;font-family:inherit"
            maxlength="2">
          <p class="text-muted text-xl" style="cursor:pointer" onclick="adjTime('m',-1)">▼</p>
        </div>
      </div>
      <div class="glass p-4 mb-4">
        <label class="text-muted text-sm" for="inp-label">Label</label>
        <input id="inp-label"
          style="width:100%;background:transparent;color:#F5F5F5;border:none;border-bottom:1px solid rgba(255,255,255,.12);padding-bottom:8px;outline:none;margin-top:4px;font-family:inherit;font-size:16px"
          placeholder="Wake German" value="Wake German">
      </div>
      <div class="glass p-4 mb-4">
        <p class="text-muted text-sm mb-3">Repeat</p>
        <div style="display:flex;gap:6px" id="day-picker"></div>
      </div>
      <div class="glass p-4 mb-4">
        <div class="flex-between mb-3"><span style="color:#F5F5F5">Voice Challenge</span>
          <div class="toggle on" id="tog-voice" onclick="toggleEl(this)"></div>
        </div>
        <div class="mb-3">
          <label class="text-muted text-sm" for="sel-difficulty">Difficulty</label>
          <select id="sel-difficulty"
            style="width:100%;padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.06);color:#F5F5F5;border:1px solid rgba(255,255,255,.1);outline:none;margin-top:4px;font-family:inherit;font-size:14px;cursor:pointer">
            <option value="all" style="background:#1A1A1F">All levels</option>
            <option value="single" style="background:#1A1A1F">Easy — Single words</option>
            <option value="compound" style="background:#1A1A1F">Medium — Compound words</option>
            <option value="sentence" style="background:#1A1A1F">Hard — Full sentences</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="text-muted text-sm" for="sel-tone">Alarm Tone</label>
          <div style="display:flex;gap:6px;margin-top:6px;flex-wrap:wrap" id="tone-picker"></div>
        </div>
        <div class="flex-between mb-3"><span style="color:#F5F5F5">Snooze</span>
          <div class="toggle on" id="tog-snooze" onclick="toggleEl(this)"></div>
        </div>
        <div class="flex-between"><span style="color:#F5F5F5">Vibration</span>
          <div class="toggle on" id="tog-vib" onclick="toggleEl(this)"></div>
        </div>
      </div>
      <button onclick="saveAlarm()" class="btn btn-primary py-4 w-full" style="font-size:18px">Save Alarm</button>
    </div>

    <!-- RING -->
    <div class="screen" id="s-ring" style="justify-content:space-between;min-height:100%">
      <div class="text-center" style="margin-top:40px">
        <p class="text-muted text-lg">Wake Up</p>
        <p class="text-7xl font-semibold anim-gentle" id="ring-time" style="color:#FF6B00;margin-top:12px">07:30</p>
        <p class="text-muted mt-2" id="ring-label">Wake German</p>
      </div>
      <div class="flex-center" style="margin:40px 0">
        <div
          style="width:160px;height:160px;border-radius:50%;background:rgba(255,107,0,.08);display:flex;align-items:center;justify-content:center">
          <div
            style="width:110px;height:110px;border-radius:50%;background:rgba(255,107,0,.12);display:flex;align-items:center;justify-content:center"
            class="anim-glow">
            <svg class="anim-bell" width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="#FF6B00"
              stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9" />
              <path d="M13.73 21a2 2 0 01-3.46 0" />
            </svg>
          </div>
        </div>
      </div>
      <div style="margin-bottom:32px">
        <button onclick="snoozeAlarm()" class="btn btn-secondary py-3 w-full mb-3" style="display:block">Snooze
          5m</button>
        <button onclick="startChallenge()" class="btn btn-primary py-4 w-full" style="font-size:18px">Start
          Challenge</button>
      </div>
    </div>

    <!-- VOICE CHALLENGE -->
    <div class="screen" id="s-challenge">
      <p class="text-center text-muted text-sm mb-4">Read this word to dismiss alarm</p>
      <div class="glass p-6 text-center mb-5" id="word-card">
        <p class="text-muted text-lg" id="ch-article"></p>
        <p class="text-4xl font-semibold mt-1" id="ch-word" style="color:#F5F5F5"></p>
        <p class="text-muted mt-2" id="ch-trans"></p>
        <p class="text-accent text-sm mt-1" id="ch-phonetic"></p>
        <button onclick="listenTTS()" class="btn btn-secondary mt-4"
          style="display:inline-flex;align-items:center;gap:8px;padding:8px 20px;margin:12px auto 0" id="listen-btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#FF9F40" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" />
            <path d="M19.07 4.93a10 10 0 010 14.14" />
            <path d="M15.54 8.46a5 5 0 010 7.07" />
          </svg>
          Listen</button>
      </div>
      <div class="flex-center mb-4" style="flex-direction:column">
        <div style="position:relative;width:140px;height:140px;display:flex;align-items:center;justify-content:center">
          <div style="position:absolute;inset:0;border-radius:50%;border:2px solid #FF6B00;display:none"
            class="anim-pulse-ring" id="pulse1"></div>
          <div style="position:absolute;inset:0;border-radius:50%;border:2px solid #FF6B00;display:none"
            class="anim-pulse-ring-d" id="pulse2"></div>
          <button id="mic-btn" onclick="toggleMic()"
            style="width:72px;height:72px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:none;cursor:pointer;background:linear-gradient(135deg,#FF6B00,#FFD700);transition:all .2s">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#0D0D0F" stroke-width="2.5"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z" />
              <path d="M19 10v2a7 7 0 01-14 0v-2" />
              <line x1="12" y1="19" x2="12" y2="23" />
              <line x1="8" y1="23" x2="16" y2="23" />
            </svg>
          </button>
        </div>
        <p class="text-muted text-sm mt-2" id="mic-status">Auto-listening...</p>
      </div>
      <div class="flex-center gap-2 mb-4" id="waveform" style="height:40px"></div>
      <p class="text-center text-muted text-sm mb-4" id="partial-text"></p>
      <div id="score-card" class="glass p-4" style="display:none">
        <div class="flex-between">
          <div>
            <p class="text-2xl font-semibold" id="score-result"></p>
            <p class="text-muted text-sm mt-1" id="score-feedback"></p>
          </div>
          <p class="text-dim text-xs" id="score-attempt"></p>
        </div>
        <div style="display:flex;gap:10px;margin-top:12px">
          <div class="glass-dark p-3" style="flex:1;text-align:center">
            <p class="text-dim text-xs">Text</p>
            <p class="text-sm font-medium" style="color:#F5F5F5" id="sc-lev"></p>
          </div>
          <div class="glass-dark p-3" style="flex:1;text-align:center">
            <p class="text-dim text-xs">Sound</p>
            <p class="text-sm font-medium" style="color:#F5F5F5" id="sc-pho"></p>
          </div>
          <div class="glass-dark p-3" style="flex:1;text-align:center">
            <p class="text-dim text-xs">Conf</p>
            <p class="text-sm font-medium" style="color:#F5F5F5" id="sc-conf"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- SETTINGS -->
    <div class="screen" id="s-settings">
      <div class="flex-between mb-5">
        <button class="icon-btn" onclick="showScreen('home')"><svg viewBox="0 0 24 24">
            <polyline points="15 18 9 12 15 6" />
          </svg></button>
        <h2 class="text-xl font-semibold" style="color:#F5F5F5">Settings</h2>
        <div style="width:40px"></div>
      </div>
      <div class="glass p-4 mb-4">
        <p class="font-semibold mb-3" style="color:#F5F5F5">Voice Recognition</p>
        <div class="flex-between mb-3"><span class="text-muted text-sm">Web Speech API</span><span
            class="text-sm font-medium" id="stt-status" style="color:#22C55E">Checking...</span></div>
        <div class="flex-between"><span class="text-muted text-sm">Language</span><span class="text-sm"
            style="color:rgba(255,255,255,.7)">German (de-DE)</span></div>
      </div>
      <div class="glass p-4 mb-4">
        <p class="font-semibold mb-3" style="color:#F5F5F5">Scoring</p>
        <div class="text-muted text-xs space-y-2">
          <p>• Levenshtein distance: 40%</p>
          <p>• Cologne Phonetic: 30%</p>
          <p>• STT Confidence: 30%</p>
          <p>• Thresholds: Short≤3→80%, Med 4-8→70%, Long>8→60%</p>
        </div>
      </div>
      <div class="glass p-4 mb-4">
        <p class="font-semibold mb-3" style="color:#F5F5F5">Vocabulary</p>
        <p class="text-muted text-sm" id="vocab-count"></p>
        <div id="cat-pills" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px"></div>
      </div>
      <button onclick="showScreen('vocab')" class="btn btn-secondary py-3 w-full mb-4">Browse Vocabulary →</button>
    </div>

    <!-- VOCAB BROWSER -->
    <div class="screen" id="s-vocab">
      <div class="flex-between mb-4">
        <button class="icon-btn" onclick="showScreen('settings')"><svg viewBox="0 0 24 24">
            <polyline points="15 18 9 12 15 6" />
          </svg></button>
        <h2 class="text-xl font-semibold" style="color:#F5F5F5">Vocabulary</h2>
        <div style="width:40px"></div>
      </div>
      <div id="vocab-filters" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px"></div>
      <div id="vocab-list" class="space-y-2" style="flex:1;overflow-y:auto;max-height:calc(100vh - 200px)"></div>
    </div>

    <!-- SUCCESS -->
    <div class="screen" id="s-success" style="justify-content:center;align-items:center;text-align:center">
      <div
        style="width:100px;height:100px;border-radius:50%;background:rgba(34,197,94,.12);display:flex;align-items:center;justify-content:center;margin:0 auto 20px">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#22C55E" stroke-width="2.5"
          stroke-linecap="round" stroke-linejoin="round">
          <polyline points="20 6 9 17 4 12" />
        </svg>
      </div>
      <h2 class="text-3xl font-bold mb-3" style="color:#F5F5F5">Challenge Complete!</h2>
      <p class="text-muted mb-2" id="success-word"></p>
      <p class="text-dim text-sm mb-6" id="success-score"></p>
      <button onclick="showScreen('home')" class="btn btn-primary py-4"
        style="padding-left:48px;padding-right:48px;font-size:18px">Done</button>
    </div>
  </div>

  <!-- FAILSAFE MODAL -->
  <div class="modal-overlay" id="failsafe-modal" style="display:none">
    <div class="modal-content">
      <h3 class="text-xl font-semibold mb-3" style="color:#F5F5F5">Fail-safe</h3>
      <p class="text-muted text-sm mb-4">5 attempts used. Choose alternative:</p>
      <div style="display:flex;gap:8px;margin-bottom:16px">
        <button onclick="showFailsafe('type')" class="btn btn-secondary py-3" style="flex:1">Type Word</button>
        <button onclick="showFailsafe('math')" class="btn btn-secondary py-3" style="flex:1">Solve Math</button>
      </div>
      <div id="fs-type" style="display:none">
        <p class="text-muted text-sm mb-2">Type: <strong style="color:#FF9F40" id="fs-expected"></strong></p>
        <input id="fs-input"
          style="width:100%;padding:12px;border-radius:12px;background:rgba(255,255,255,.06);color:#F5F5F5;border:1px solid rgba(255,255,255,.1);outline:none;margin-bottom:12px;font-family:inherit;font-size:16px"
          placeholder="Type the word...">
        <button onclick="checkFailsafe('type')" class="btn btn-primary py-3 w-full">Submit</button>
      </div>
      <div id="fs-math" style="display:none">
        <p class="text-2xl font-semibold text-center mb-3" style="color:#FF9F40" id="fs-question"></p>
        <input id="fs-math-input" type="number"
          style="width:100%;padding:12px;border-radius:12px;background:rgba(255,255,255,.06);color:#F5F5F5;border:1px solid rgba(255,255,255,.1);outline:none;margin-bottom:12px;font-family:inherit;font-size:24px;text-align:center"
          placeholder="?">
        <button onclick="checkFailsafe('math')" class="btn btn-primary py-3 w-full">Submit</button>
      </div>
      <p id="fs-error" style="color:#EF4444;font-size:14px;margin-top:8px;display:none"></p>
    </div>
  </div>

  <script src="vocab.js"></script>
  <script>
    // === CONSTANTS ===
    var SCORING_WEIGHTS = { LEVENSHTEIN: 0.4, PHONETIC: 0.3, CONFIDENCE: 0.3 };
    var DYNAMIC_THRESHOLDS = { SHORT: { maxLength: 3, threshold: 0.80 }, MEDIUM: { maxLength: 8, threshold: 0.70 }, LONG: { maxLength: Infinity, threshold: 0.60 } };
    var MAX_VOICE_ATTEMPTS = 5;
    var DAY_LABELS = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
    var MIC_TIMEOUT_MS = 10000;

    // === ALARM TONES ===
    var ALARM_TONES = [
      { id: 'classic', name: 'Classic', freq: 880, pattern: 'steady' },
      { id: 'digital', name: 'Digital', freq: 1200, pattern: 'beep' },
      { id: 'gentle', name: 'Gentle', freq: 440, pattern: 'soft' },
      { id: 'urgent', name: 'Urgent', freq: 1000, pattern: 'fast' }
    ];
    var selectedTone = 'classic';

    // === SCORING ENGINE ===
    function levenshteinDistance(a, b) { var m = a.length, n = b.length, dp = []; for (var i = 0; i <= m; i++) { dp[i] = []; for (var j = 0; j <= n; j++)dp[i][j] = 0; } for (var i = 0; i <= m; i++)dp[i][0] = i; for (var j = 0; j <= n; j++)dp[0][j] = j; for (var i = 1; i <= m; i++)for (var j = 1; j <= n; j++) { if (a[i - 1] === b[j - 1]) dp[i][j] = dp[i - 1][j - 1]; else dp[i][j] = 1 + Math.min(dp[i - 1][j], dp[i][j - 1], dp[i - 1][j - 1]); } return dp[m][n]; }
    function levenshteinScore(a, b) { var mx = Math.max(a.length, b.length); return mx === 0 ? 1 : 1 - levenshteinDistance(a, b) / mx; }
    function colognePhonetic(word) { if (!word) return ''; var inp = word.toUpperCase().replace(/Ä/g, 'AE').replace(/Ö/g, 'OE').replace(/Ü/g, 'UE').replace(/ß/g, 'SS').replace(/[^A-Z]/g, ''); if (!inp) return ''; var codes = []; for (var i = 0; i < inp.length; i++) { var c = inp[i], p = i > 0 ? inp[i - 1] : '', n = i < inp.length - 1 ? inp[i + 1] : '', code = ''; if ('AEIOU'.indexOf(c) >= 0) code = '0'; else if (c === 'H') code = ''; else if (c === 'B' || c === 'P') code = n === 'H' ? '3' : '1'; else if (c === 'D' || c === 'T') code = 'CSZ'.indexOf(n) >= 0 ? '8' : '2'; else if (c === 'F' || c === 'V' || c === 'W') code = '3'; else if (c === 'G' || c === 'K' || c === 'Q') code = '4'; else if (c === 'X') code = '48'; else if (c === 'L') code = '5'; else if (c === 'M' || c === 'N') code = '6'; else if (c === 'R') code = '7'; else if (c === 'S' || c === 'Z') code = '8'; else if (c === 'C') { if (i === 0) code = 'AHKLOQRUX'.indexOf(n) >= 0 ? '4' : '8'; else if ('AEIOU'.indexOf(p) >= 0 && 'AHKOQUX'.indexOf(n) >= 0) code = '4'; else if ('SZ'.indexOf(p) >= 0) code = '8'; else code = 'AHKOQUX'.indexOf(n) >= 0 ? '4' : '8'; } else if (c === 'J' || c === 'Y') code = '0'; codes.push(code); } var r = codes.join(''), d = ''; for (var i = 0; i < r.length; i++)if (i === 0 || r[i] !== r[i - 1]) d += r[i]; return d.length > 0 ? d[0] + d.substring(1).replace(/0/g, '') : ''; }
    function phoneticScore(a, b) { var c1 = colognePhonetic(a), c2 = colognePhonetic(b); if (!c1 && !c2) return 1; if (!c1 || !c2) return 0; if (c1 === c2) return 1; var mx = Math.max(c1.length, c2.length); return 1 - levenshteinDistance(c1, c2) / mx; }
    var ARTICLES_LIST = ['der', 'die', 'das', 'ein', 'eine', 'einem', 'einen', 'einer', 'eines'];
    function normalize(text) { var r = text.toLowerCase().trim().replace(/[.,!?;:'"()\-]/g, ''); for (var k = 0; k < ARTICLES_LIST.length; k++) { var a = ARTICLES_LIST[k]; if (r.indexOf(a + ' ') === 0) { r = r.substring(a.length + 1).trim(); break; } } return r.trim(); }
    function getDynamicThreshold(len) { if (len <= DYNAMIC_THRESHOLDS.SHORT.maxLength) return DYNAMIC_THRESHOLDS.SHORT.threshold; if (len <= DYNAMIC_THRESHOLDS.MEDIUM.maxLength) return DYNAMIC_THRESHOLDS.MEDIUM.threshold; return DYNAMIC_THRESHOLDS.LONG.threshold; }
    function evaluateChallenge(expected, spoken, sttConf) { var ne = normalize(expected), ns = normalize(spoken); var lev = levenshteinScore(ne, ns), pho = phoneticScore(ne, ns), conf = Math.max(0, Math.min(1, sttConf)); var combined = lev * SCORING_WEIGHTS.LEVENSHTEIN + pho * SCORING_WEIGHTS.PHONETIC + conf * SCORING_WEIGHTS.CONFIDENCE; var threshold = getDynamicThreshold(ne.length); var passed = combined >= threshold; var feedback; if (passed) feedback = combined >= 0.9 ? 'Perfect!' : 'Correct! Well done.'; else if (combined >= threshold - 0.1) feedback = 'Almost! Try once more.'; else feedback = 'Not quite. Listen and try again.'; return { levenshteinScore: lev, phoneticScore: pho, confidenceScore: conf, combinedScore: combined, threshold: threshold, passed: passed, feedback: feedback }; }
    function generateMathProblem() { var ops = ['+', '-']; var op = ops[Math.floor(Math.random() * 2)]; var a, b, ans; if (op === '+') { a = Math.floor(Math.random() * 90) + 10; b = Math.floor(Math.random() * 90) + 10; ans = a + b; } else { a = Math.floor(Math.random() * 90) + 10; b = Math.floor(Math.random() * (a - 1)) + 1; ans = a - b; } return { question: a + ' ' + op + ' ' + b + ' = ?', answer: ans }; }

    // === APP STATE ===
    var currentScreen = 'home';
    var alarms = JSON.parse(localStorage.getItem('s2w_alarms') || '[]');
    var editingId = null;
    var challenge = { word: null, attempts: 0, listening: false };
    var mathProblem = null;
    var recognition = null;
    var selectedDays = [1, 2, 3, 4, 5];
    var vocabFilter = 'all';
    var alarmAudioCtx = null;
    var alarmOsc = null;
    var alarmGain = null;
    var alarmInterval = null;
    var alarmPlaying = false;
    var selectedDifficulty = 'all';
    var micTimeout = null;
    var autoMicTimer = null;

    // === ALARM SOUND (continuous loop) ===
    function startAlarmLoop() {
      stopAlarmLoop();
      alarmPlaying = true;
      playAlarmTone();
      alarmInterval = setInterval(playAlarmTone, 2500);
    }
    function playAlarmTone() {
      if (!alarmPlaying) return;
      var tone = ALARM_TONES.find(function (t) { return t.id === selectedTone; }) || ALARM_TONES[0];
      try {
        var ac = new (window.AudioContext || window.webkitAudioContext)();
        var o = ac.createOscillator(); var g = ac.createGain();
        o.connect(g); g.connect(ac.destination);
        o.frequency.value = tone.freq;
        if (tone.pattern === 'soft') { g.gain.value = 0.12; o.type = 'sine'; }
        else if (tone.pattern === 'beep') { g.gain.value = 0.2; o.type = 'square'; }
        else if (tone.pattern === 'fast') { g.gain.value = 0.3; o.type = 'sawtooth'; }
        else { g.gain.value = 0.25; o.type = 'sine'; }
        o.start();
        g.gain.exponentialRampToValueAtTime(0.01, ac.currentTime + 1.8);
        setTimeout(function () { o.stop(); ac.close(); }, 2000);
      } catch (e) { }
    }
    function pauseAlarm() { alarmPlaying = false; if (alarmInterval) { clearInterval(alarmInterval); alarmInterval = null; } }
    function resumeAlarm() { if (currentScreen === 'challenge' || currentScreen === 'ring') { alarmPlaying = true; playAlarmTone(); alarmInterval = setInterval(playAlarmTone, 2500); } }
    function stopAlarmLoop() { alarmPlaying = false; if (alarmInterval) { clearInterval(alarmInterval); alarmInterval = null; } }

    // === NAVIGATION ===
    function showScreen(name) {
      var screens = document.querySelectorAll('.screen');
      for (var i = 0; i < screens.length; i++)screens[i].classList.remove('active');
      document.getElementById('s-' + name).classList.add('active');
      currentScreen = name;
      if (name === 'home') { renderHome(); stopAlarmLoop(); }
      if (name === 'settings') renderSettings();
      if (name === 'vocab') renderVocab();
      if (name === 'add') renderAddScreen();
      if (name === 'success') stopAlarmLoop();
    }

    // === ALARM CRUD ===
    function renderHome() {
      var list = document.getElementById('alarm-list');
      var banner = document.getElementById('next-alarm-banner');
      if (alarms.length === 0) {
        list.innerHTML = '<p class="text-center text-muted" style="margin-top:32px">No alarms yet. Tap + to add one.</p>';
        banner.innerHTML = '<p class="text-muted text-sm">No upcoming alarm</p><p class="text-3xl font-semibold mt-1" style="color:rgba(255,255,255,.2)">--:--</p>';
        return;
      }
      var active = alarms.filter(function (a) { return a.enabled; }).sort(function (a, b) { return a.time.localeCompare(b.time); });
      if (active.length > 0) {
        var next = active[0];
        banner.innerHTML = '<p class="text-muted text-sm">Next Alarm</p><p class="text-5xl font-semibold mt-1" style="color:#FF6B00">' + next.time + '</p><p class="text-dim text-sm mt-1">' + next.label + '</p>';
      } else {
        banner.innerHTML = '<p class="text-muted text-sm">All alarms off</p><p class="text-3xl font-semibold mt-1" style="color:rgba(255,255,255,.15)">--:--</p>';
      }
      list.innerHTML = alarms.map(function (a) {
        var dayStr = a.days.length === 7 ? 'Every day' : a.days.length === 5 ? 'Weekdays' : a.days.map(function (d) { return DAY_LABELS[d]; }).join(',');
        return '<div class="glass alarm-card p-4" onclick="editAlarm(\'' + a.id + '\')">' +
          '<div class="flex-between"><div>' +
          '<p class="text-4xl font-semibold" style="color:' + (a.enabled ? '#F5F5F5' : 'rgba(255,255,255,.25)') + '">' + a.time + '</p>' +
          '<div style="display:flex;align-items:center;gap:8px;margin-top:4px"><span class="text-muted text-sm">' + a.label + '</span><span class="text-dim text-xs">' + dayStr + '</span></div>' +
          (a.voiceChallenge ? '<div style="margin-top:8px"><span style="background:rgba(255,107,0,.12);color:#FF9F40;font-size:11px;padding:3px 10px;border-radius:20px">Voice ' + (a.difficulty === 'sentence' ? '(Hard)' : a.difficulty === 'compound' ? '(Medium)' : a.difficulty === 'single' ? '(Easy)' : '') + '</span></div>' : '') +
          '</div><div class="toggle ' + (a.enabled ? 'on' : 'off') + '" onclick="event.stopPropagation();toggleAlarmEnabled(\'' + a.id + '\')"></div></div></div>';
      }).join('');
    }
    function renderAddScreen() {
      document.getElementById('add-title').textContent = editingId ? 'Edit Alarm' : 'New Alarm';
      var dp = document.getElementById('day-picker');
      dp.innerHTML = DAY_LABELS.map(function (d, i) { return '<button class="day-btn ' + (selectedDays.indexOf(i) >= 0 ? 'active' : 'inactive') + '" onclick="toggleDay(' + i + ')">' + d + '</button>'; }).join('');
      // Tone picker
      var tp = document.getElementById('tone-picker');
      if (tp) tp.innerHTML = ALARM_TONES.map(function (t) { return '<button class="cat-pill ' + (selectedTone === t.id ? 'active' : 'inactive') + '" onclick="selectTone(\'' + t.id + '\')" style="font-size:12px">' + t.name + '</button>'; }).join('');
      if (editingId) { var alarm = alarms.find(function (a) { return a.id === editingId; }); if (alarm) { document.getElementById('inp-h').value = alarm.time.split(':')[0]; document.getElementById('inp-m').value = alarm.time.split(':')[1]; document.getElementById('inp-label').value = alarm.label; selectedDays = alarm.days.slice(); selectedTone = alarm.tone || 'classic'; selectedDifficulty = alarm.difficulty || 'all'; document.getElementById('sel-difficulty').value = selectedDifficulty; dp.innerHTML = DAY_LABELS.map(function (d, i) { return '<button class="day-btn ' + (selectedDays.indexOf(i) >= 0 ? 'active' : 'inactive') + '" onclick="toggleDay(' + i + ')">' + d + '</button>'; }).join(''); if (tp) tp.innerHTML = ALARM_TONES.map(function (t) { return '<button class="cat-pill ' + (selectedTone === t.id ? 'active' : 'inactive') + '" onclick="selectTone(\'' + t.id + '\')" style="font-size:12px">' + t.name + '</button>'; }).join(''); } }
    }
    function selectTone(id) { selectedTone = id; var tp = document.getElementById('tone-picker'); if (tp) tp.innerHTML = ALARM_TONES.map(function (t) { return '<button class="cat-pill ' + (selectedTone === t.id ? 'active' : 'inactive') + '" onclick="selectTone(\'' + t.id + '\')" style="font-size:12px">' + t.name + '</button>'; }).join(''); }
    function previewTone(id) { var old = selectedTone; selectedTone = id; playAlarmTone(); selectedTone = old; }
    function adjTime(unit, dir) { var el = document.getElementById(unit === 'h' ? 'inp-h' : 'inp-m'); var v = parseInt(el.value) || 0; var max = unit === 'h' ? 23 : 59; v += dir; if (v < 0) v = max; if (v > max) v = 0; el.value = String(v).padStart(2, '0'); }
    function toggleDay(i) { var idx = selectedDays.indexOf(i); if (idx >= 0) selectedDays.splice(idx, 1); else selectedDays.push(i); renderAddScreen(); }
    function saveAlarm() { var h = document.getElementById('inp-h').value.padStart(2, '0'); var m = document.getElementById('inp-m').value.padStart(2, '0'); var label = document.getElementById('inp-label').value || 'Alarm'; var voice = document.getElementById('tog-voice').classList.contains('on'); var diff = document.getElementById('sel-difficulty').value; if (editingId) { var alarm = alarms.find(function (a) { return a.id === editingId; }); if (alarm) { alarm.time = h + ':' + m; alarm.label = label; alarm.days = selectedDays.slice(); alarm.voiceChallenge = voice; alarm.tone = selectedTone; alarm.difficulty = diff; } editingId = null; } else { alarms.push({ id: Date.now().toString(), time: h + ':' + m, label: label, days: selectedDays.slice(), enabled: true, voiceChallenge: voice, tone: selectedTone, difficulty: diff }); } localStorage.setItem('s2w_alarms', JSON.stringify(alarms)); selectedDays = [1, 2, 3, 4, 5]; selectedTone = 'classic'; editingId = null; showScreen('home'); }
    function editAlarm(id) { editingId = id; showScreen('add'); }
    function toggleAlarmEnabled(id) { var a = alarms.find(function (x) { return x.id === id; }); if (a) a.enabled = !a.enabled; localStorage.setItem('s2w_alarms', JSON.stringify(alarms)); renderHome(); }
    function toggleEl(el) { el.classList.toggle('on'); el.classList.toggle('off'); }

    // === SIMULATE ALARM ===
    function simulateAlarm() {
      var active = alarms.filter(function (a) { return a.enabled; });
      var now = new Date();
      var alarm = active.length > 0 ? active[0] : { time: String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0'), label: 'Demo Alarm', tone: 'classic', difficulty: 'all' };
      document.getElementById('ring-time').textContent = alarm.time;
      document.getElementById('ring-label').textContent = alarm.label;
      selectedTone = alarm.tone || 'classic';
      selectedDifficulty = alarm.difficulty || 'all';
      showScreen('ring');
      startAlarmLoop();
    }
    function snoozeAlarm() { stopAlarmLoop(); showScreen('home'); }

    // === VOICE CHALLENGE ===
    function startChallenge() {
      // Filter vocab by difficulty if alarm has a setting
      var diff = selectedDifficulty || 'all';
      var pool = diff === 'all' ? VOCAB : VOCAB.filter(function (w) { return w.difficulty === diff; });
      if (pool.length === 0) pool = VOCAB;
      var word = pool[Math.floor(Math.random() * pool.length)];
      challenge = { word: word, attempts: 0, listening: false };
      document.getElementById('ch-article').textContent = word.article || '';
      document.getElementById('ch-word').textContent = word.bare;
      document.getElementById('ch-trans').textContent = word.translation;
      document.getElementById('ch-phonetic').textContent = '/' + word.phonetic + '/';
      document.getElementById('score-card').style.display = 'none';
      document.getElementById('partial-text').textContent = '';
      document.getElementById('mic-status').textContent = 'Auto-listening...';
      document.getElementById('pulse1').style.display = 'none';
      document.getElementById('pulse2').style.display = 'none';
      showScreen('challenge');
      initWaveform();
      // Auto-start mic after 1.5s
      clearTimeout(autoMicTimer);
      autoMicTimer = setTimeout(function () { startListening(); }, 1500);
    }
    function listenTTS() {
      if (!challenge.word) return;
      pauseAlarm();
      var u = new SpeechSynthesisUtterance(challenge.word.word);
      u.lang = 'de-DE'; u.rate = 0.8;
      u.onend = function () { if (currentScreen === 'challenge' && !challenge.listening) resumeAlarm(); };
      speechSynthesis.speak(u);
    }
    function initWaveform() { var wf = document.getElementById('waveform'); wf.innerHTML = ''; for (var i = 0; i < 24; i++) { var bar = document.createElement('div'); bar.className = 'waveform-bar'; bar.style.height = '3px'; wf.appendChild(bar); } }
    function animateWaveform(active) { var bars = document.querySelectorAll('.waveform-bar'); for (var i = 0; i < bars.length; i++)bars[i].style.height = active ? (Math.random() * 32 + 3) + 'px' : '3px'; }
    function toggleMic() {
      if (challenge.listening) { stopListening(); resumeAlarm(); return; }
      if (challenge.attempts >= MAX_VOICE_ATTEMPTS) { openFailsafe(); return; }
      startListening();
    }
    function startListening() {
      var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { document.getElementById('mic-status').textContent = 'Speech not supported. Use Chrome.'; return; }
      pauseAlarm();
      recognition = new SR(); recognition.lang = 'de-DE'; recognition.continuous = false; recognition.interimResults = true; recognition.maxAlternatives = 1;
      challenge.listening = true;
      document.getElementById('mic-status').textContent = 'Listening...';
      document.getElementById('mic-btn').style.background = 'linear-gradient(135deg,#EF4444,#DC2626)';
      document.getElementById('pulse1').style.display = 'block';
      document.getElementById('pulse2').style.display = 'block';
      var wfInt = setInterval(function () { if (challenge.listening) animateWaveform(true); else { clearInterval(wfInt); animateWaveform(false); } }, 100);
      // 10s timeout
      clearTimeout(micTimeout);
      micTimeout = setTimeout(function () {
        if (challenge.listening) {
          stopListening();
          document.getElementById('mic-status').textContent = 'No speech detected. Retrying...';
          resumeAlarm();
          // Auto-retry after 2s
          clearTimeout(autoMicTimer);
          autoMicTimer = setTimeout(function () { if (currentScreen === 'challenge' && challenge.attempts < MAX_VOICE_ATTEMPTS) startListening(); }, 2000);
        }
      }, MIC_TIMEOUT_MS);
      recognition.onresult = function (e) {
        var transcript = '', confidence = 0;
        for (var i = 0; i < e.results.length; i++) {
          transcript = e.results[i][0].transcript; confidence = e.results[i][0].confidence;
          if (e.results[i].isFinal) { stopListening(); processResult(transcript, confidence); return; }
        }
        document.getElementById('partial-text').textContent = '"' + transcript + '..."';
      };
      recognition.onerror = function (e) {
        stopListening();
        if (e.error === 'no-speech') document.getElementById('mic-status').textContent = 'No speech. Retrying...';
        else document.getElementById('mic-status').textContent = 'Error: ' + e.error;
        resumeAlarm();
        clearTimeout(autoMicTimer);
        autoMicTimer = setTimeout(function () { if (currentScreen === 'challenge' && challenge.attempts < MAX_VOICE_ATTEMPTS) startListening(); }, 2000);
      };
      recognition.onend = function () { if (challenge.listening) stopListening(); };
      try { recognition.start(); } catch (e) { stopListening(); resumeAlarm(); }
    }
    function stopListening() {
      challenge.listening = false; clearTimeout(micTimeout);
      if (recognition) try { recognition.stop(); } catch (e) { }
      document.getElementById('mic-btn').style.background = 'linear-gradient(135deg,#FF6B00,#FFD700)';
      document.getElementById('pulse1').style.display = 'none';
      document.getElementById('pulse2').style.display = 'none';
      animateWaveform(false);
    }
    function processResult(transcript, confidence) {
      challenge.attempts++;
      var result = evaluateChallenge(challenge.word.bare, transcript, confidence);
      document.getElementById('score-card').style.display = 'block';
      var pct = Math.round(result.combinedScore * 100);
      document.getElementById('score-result').textContent = (result.passed ? '✓ ' : '✗ ') + pct + '%';
      document.getElementById('score-result').style.color = result.passed ? '#22C55E' : '#EF4444';
      document.getElementById('score-feedback').textContent = result.feedback;
      document.getElementById('score-attempt').textContent = 'Attempt ' + challenge.attempts + '/' + MAX_VOICE_ATTEMPTS;
      document.getElementById('sc-lev').textContent = Math.round(result.levenshteinScore * 100) + '%';
      document.getElementById('sc-pho').textContent = Math.round(result.phoneticScore * 100) + '%';
      document.getElementById('sc-conf').textContent = Math.round(result.confidenceScore * 100) + '%';
      document.getElementById('partial-text').textContent = '"' + transcript + '"';
      if (result.passed) {
        document.getElementById('mic-status').textContent = 'Correct!';
        stopAlarmLoop();
        setTimeout(function () {
          document.getElementById('success-word').textContent = (challenge.word.article ? challenge.word.article + ' ' : '') + challenge.word.bare + ' — ' + challenge.word.translation;
          document.getElementById('success-score').textContent = 'Score: ' + pct + '% (Threshold: ' + Math.round(result.threshold * 100) + '%)';
          showScreen('success');
        }, 1500);
      } else if (challenge.attempts >= MAX_VOICE_ATTEMPTS) {
        document.getElementById('mic-status').textContent = 'Max attempts reached';
        setTimeout(openFailsafe, 1000);
      } else {
        document.getElementById('word-card').classList.add('anim-shake');
        setTimeout(function () { document.getElementById('word-card').classList.remove('anim-shake'); }, 400);
        resumeAlarm();
        // Auto-retry
        clearTimeout(autoMicTimer);
        autoMicTimer = setTimeout(function () { if (currentScreen === 'challenge') startListening(); }, 2500);
      }
    }

    // === FAILSAFE ===
    function openFailsafe() { stopAlarmLoop(); document.getElementById('failsafe-modal').style.display = 'flex'; document.getElementById('fs-type').style.display = 'none'; document.getElementById('fs-math').style.display = 'none'; document.getElementById('fs-error').style.display = 'none'; }
    function showFailsafe(mode) { document.getElementById('fs-type').style.display = mode === 'type' ? 'block' : 'none'; document.getElementById('fs-math').style.display = mode === 'math' ? 'block' : 'none'; document.getElementById('fs-error').style.display = 'none'; if (mode === 'type') { document.getElementById('fs-expected').textContent = challenge.word.bare; document.getElementById('fs-input').value = ''; document.getElementById('fs-input').focus(); } if (mode === 'math') { mathProblem = generateMathProblem(); document.getElementById('fs-question').textContent = mathProblem.question; document.getElementById('fs-math-input').value = ''; document.getElementById('fs-math-input').focus(); } }
    function checkFailsafe(mode) { if (mode === 'type') { if (normalize(document.getElementById('fs-input').value) === normalize(challenge.word.bare)) { document.getElementById('failsafe-modal').style.display = 'none'; showScreen('home'); } else { document.getElementById('fs-error').textContent = 'Incorrect. Try again.'; document.getElementById('fs-error').style.display = 'block'; } } if (mode === 'math') { if (parseInt(document.getElementById('fs-math-input').value) === mathProblem.answer) { document.getElementById('failsafe-modal').style.display = 'none'; showScreen('home'); } else { document.getElementById('fs-error').textContent = 'Wrong answer.'; document.getElementById('fs-error').style.display = 'block'; } } }

    // === SETTINGS ===
    function renderSettings() { var SR = window.SpeechRecognition || window.webkitSpeechRecognition; document.getElementById('stt-status').textContent = SR ? '✓ Ready' : '✗ Not available'; document.getElementById('stt-status').style.color = SR ? '#22C55E' : '#EF4444'; var s = VOCAB.filter(function (w) { return w.difficulty === 'single'; }).length; var c = VOCAB.filter(function (w) { return w.difficulty === 'compound'; }).length; var se = VOCAB.filter(function (w) { return w.difficulty === 'sentence'; }).length; document.getElementById('vocab-count').textContent = VOCAB.length + ' items: ' + s + ' single, ' + c + ' compound, ' + se + ' sentences'; var pills = document.getElementById('cat-pills'); pills.innerHTML = CATEGORIES.map(function (cat) { var n = VOCAB.filter(function (w) { return w.category === cat; }).length; return '<span class="cat-pill inactive">' + cat + ' (' + n + ')</span>'; }).join(''); }

    // === VOCABULARY ===
    function renderVocab() { var f = document.getElementById('vocab-filters'); f.innerHTML = '<button class="cat-pill ' + (vocabFilter === 'all' ? 'active' : 'inactive') + '" onclick="setVocabFilter(\'all\')">All (' + VOCAB.length + ')</button>' + CATEGORIES.map(function (c) { return '<button class="cat-pill ' + (vocabFilter === c ? 'active' : 'inactive') + '" onclick="setVocabFilter(\'' + c + '\')">' + c + ' (' + VOCAB.filter(function (w) { return w.category === c; }).length + ')</button>'; }).join(''); var words = vocabFilter === 'all' ? VOCAB : VOCAB.filter(function (w) { return w.category === vocabFilter; }); var list = document.getElementById('vocab-list'); list.innerHTML = words.slice(0, 100).map(function (w) { return '<div class="glass-dark p-3 flex-between"><div><span class="text-dim text-xs">' + w.article + '</span> <span style="color:#F5F5F5" class="font-medium">' + w.bare + '</span> <span class="text-muted text-sm" style="margin-left:8px">' + w.translation + '</span></div><button onclick="speakVocab(\'' + w.word.replace(/'/g, "\\'") + '\')" class="icon-btn" style="width:32px;height:32px"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#FF9F40" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 010 7.07"/></svg></button></div>'; }).join('') + (words.length > 100 ? '<p class="text-center text-dim text-xs mt-3">Showing 100 of ' + words.length + '</p>' : ''); }
    function setVocabFilter(cat) { vocabFilter = cat; renderVocab(); }
    function speakVocab(word) { var u = new SpeechSynthesisUtterance(word); u.lang = 'de-DE'; u.rate = 0.8; speechSynthesis.speak(u); }

    // === CLOCK ===
    function updateClock() { var now = new Date(); document.getElementById('clock').textContent = String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0'); }
    setInterval(updateClock, 10000); updateClock();

    // === INIT ===
    if (alarms.length === 0) { alarms = [{ id: '1', time: '07:30', label: 'Wake German', days: [1, 2, 3, 4, 5], enabled: true, voiceChallenge: true, tone: 'classic', difficulty: 'all' }, { id: '2', time: '22:00', label: 'Evening Review', days: [0, 6], enabled: true, voiceChallenge: true, tone: 'gentle', difficulty: 'single' }]; localStorage.setItem('s2w_alarms', JSON.stringify(alarms)); }
    renderHome();
  </script>
</body>

</html>